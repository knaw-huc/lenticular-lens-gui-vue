<template>
  <card :id="'export_' + type + '_' + spec.id" type="export" :res-id="spec.id" :label="spec.label"
        @show="onToggle(true)" @hide="onToggle(false)">
    <div class="row align-items-stretch justify-content-around">
      <sub-card label="Format" class="col-export">
        <div class="custom-control custom-switch mt-3">
          <input type="radio" class="custom-control-input" autocomplete="off"
                 :id="'export_csv_' + type + '_' + spec.id" value="csv"
                 v-model="format" @change="updateState('export_csv')"/>
          <label class="custom-control-label" :for="'export_csv_' + type + '_' + spec.id">
            CSV
          </label>
        </div>

        <div class="custom-control custom-switch">
          <input type="radio" class="custom-control-input" autocomplete="off"
                 :id="'export_turtle_' + type + '_' + spec.id" value="turtle"
                 v-model="format" @change="updateState('export_turtle')"/>
          <label class="custom-control-label" :for="'export_turtle_' + type + '_' + spec.id">
            RDF Turtle
          </label>
        </div>

        <div class="custom-control custom-switch">
          <input type="radio" class="custom-control-input" autocomplete="off"
                 :id="'export_trig_' + type + '_' + spec.id" value="trig"
                 v-model="format" @change="updateState('export_trig')"/>
          <label class="custom-control-label" :for="'export_trig_' + type + '_' + spec.id">
            RDF TriG
          </label>
        </div>
      </sub-card>

      <sub-card label="Data" class="col-export">
        <div class="custom-control custom-switch mt-3">
          <input type="checkbox" class="custom-control-input" autocomplete="off"
                 :id="'export_metadata_' + type + '_' + spec.id" :disabled="format === 'csv'"
                 v-model="exportMetadata" @change="updateState('export_metadata')"/>
          <label class="custom-control-label" :for="'export_metadata_' + type + '_' + spec.id">
            Metadata
          </label>
        </div>

        <div class="custom-control custom-switch">
          <input type="checkbox" class="custom-control-input" autocomplete="off"
                 :id="'export_linkset_' + type + '_' + spec.id" :disabled="format === 'csv'"
                 v-model="exportLinkset" @change="updateState('export_linkset')"/>
          <label class="custom-control-label" :for="'export_linkset_' + type + '_' + spec.id">
            Linkset
          </label>
        </div>
      </sub-card>

      <sub-card label="Restrictions" class="col-export">
        <div class="custom-control custom-switch mt-3">
          <input type="checkbox" class="custom-control-input" autocomplete="off"
                 :id="'export_all_links_' + type + '_' + spec.id"
                 v-model="exportAllLinks" @change="updateState('export_all_links')"/>
          <label class="custom-control-label" :for="'export_all_links_' + type + '_' + spec.id">
            All links
          </label>
        </div>

        <div class="custom-control custom-switch">
          <input type="checkbox" class="custom-control-input" autocomplete="off"
                 :id="'export_validated_links_' + type + '_' + spec.id"
                 v-model="exportValidatedLinks" @change="updateState('export_validated_links')"/>
          <label class="custom-control-label" :for="'export_validated_links_' + type + '_' + spec.id">
            Validated links
          </label>
        </div>

        <div class="custom-control custom-switch">
          <input type="checkbox" class="custom-control-input" autocomplete="off"
                 :id="'export_not_validated_links_' + type + '_' + spec.id"
                 v-model="exportNotValidatedLinks" @change="updateState('export_not_validated_links')"/>
          <label class="custom-control-label" :for="'export_not_validated_links_' + type + '_' + spec.id">
            Not validated links
          </label>
        </div>

        <div class="custom-control custom-switch">
          <input type="checkbox" class="custom-control-input" autocomplete="off"
                 :id="'export_accepted_links_' + type + '_' + spec.id"
                 v-model="exportAcceptedLinks" @change="updateState('export_accepted_links')"/>
          <label class="custom-control-label" :for="'export_accepted_links_' + type + '_' + spec.id">
            Accepted links
          </label>
        </div>

        <div class="custom-control custom-switch">
          <input type="checkbox" class="custom-control-input" autocomplete="off"
                 :id="'export_rejected_links_' + type + '_' + spec.id"
                 v-model="exportRejectedLinks" @change="updateState('export_rejected_links')"/>
          <label class="custom-control-label" :for="'export_rejected_links_' + type + '_' + spec.id">
            Rejected links
          </label>
        </div>

        <div class="custom-control custom-switch">
          <input type="checkbox" class="custom-control-input" autocomplete="off"
                 :id="'export_unsure_links_' + type + '_' + spec.id"
                 v-model="exportUnsureLinks" @change="updateState('export_unsure_links')"/>
          <label class="custom-control-label" :for="'export_unsure_links_' + type + '_' + spec.id">
            Unsure links
          </label>
        </div>
      </sub-card>

      <sub-card label="RDF reification" class="col-export">
        <div class="custom-control custom-switch mt-3">
          <input type="radio" class="custom-control-input" autocomplete="off"
                 :id="'export_none_reif_' + type + '_' + spec.id" value="none" :disabled="format === 'csv'"
                 v-model="reification" @change="updateState('export_none_reif')"/>
          <label class="custom-control-label" :for="'export_none_reif_' + type + '_' + spec.id">
            No links metadata
          </label>
        </div>

        <div class="custom-control custom-switch">
          <input type="radio" class="custom-control-input" autocomplete="off"
                 :id="'export_standard_reif_' + type + '_' + spec.id" value="standard" :disabled="format === 'csv'"
                 v-model="reification" @change="updateState('export_standard_reif')"/>
          <label class="custom-control-label" :for="'export_standard_reif_' + type + '_' + spec.id">
            Standard RDF reification
          </label>
        </div>

        <div class="custom-control custom-switch">
          <input type="radio" class="custom-control-input" autocomplete="off"
                 :id="'export_rdf_star_reif_' + type + '_' + spec.id" value="rdf_star" :disabled="format === 'csv'"
                 v-model="reification" @change="updateState('export_rdf_star_reif')"/>
          <label class="custom-control-label" :for="'export_rdf_star_reif_' + type + '_' + spec.id">
            RDF*
          </label>
        </div>

        <div class="custom-control custom-switch">
          <input type="radio" class="custom-control-input" autocomplete="off"
                 :id="'export_singleton_reif_' + type + '_' + spec.id" value="singleton" :disabled="format === 'csv'"
                 v-model="reification" @change="updateState('export_singleton_reif')"/>
          <label class="custom-control-label" :for="'export_singleton_reif_' + type + '_' + spec.id">
            Singleton
          </label>
        </div>
      </sub-card>

      <sub-card label="RDF link predicate" class="col-export">
        <v-select :value="selectedLinkPredicate" :options="linkPredicatesList"
                  :clearable="false" :disabled="format === 'csv'"
                  class="mt-3" autocomplete="off" placeholder="Select a link predicate" @input="selectLinkPredicate">
          <div slot="option" slot-scope="option">
            <div v-if="!option.predicate" class="text-secondary text-bold font-italic">
              Provide another link predicate
            </div>

            <template v-else>
              <div class="font-weight-bold">{{ option.label }}</div>
              <div class="text-muted text-wrap font-italic smaller pt-1">
                {{ option.uri + option.predicate }}
              </div>
            </template>
          </div>
        </v-select>

        <template v-if="!predicate">
          <div class="input-group input-group-sm mt-3">
            <div class="input-group-prepend">
              <span class="input-group-text">Namespace</span>
            </div>
            <input type="text" class="form-control" placeholder="Prefix" style="max-width:80px;"
                   v-model="prefix" :disabled="format === 'csv'"/>
            <input type="text" class="form-control" placeholder="URI"
                   v-model="uri" :disabled="format === 'csv'"/>
          </div>

          <div class="input-group input-group-sm mt-3">
            <div class="input-group-prepend">
              <span class="input-group-text">{{ prefix }}:</span>
            </div>
            <input type="text" class="form-control" placeholder="Match predicate"
                   v-model="predicate" :disabled="format === 'csv'"/>
          </div>
        </template>
      </sub-card>

      <sub-card label="Metadata" class="col-export">
        <div class="row form-group mt-3">
          <label :for="`creator_${type}_${spec.id}`" class="col-auto">Creator:</label>
          <div class="col-auto">
            <input type="text" class="form-control form-control-sm" :id="`creator_${type}_${spec.id}`"
                   v-model="creator" :disabled="format === 'csv'"/>
          </div>
        </div>

        <div class="row form-group mt-3">
          <label :for="`publisher_${type}_${spec.id}`" class="col-auto">Publisher:</label>
          <div class="col-auto">
            <input type="text" class="form-control form-control-sm" :id="`publisher_${type}_${spec.id}`"
                   v-model="publisher" :disabled="format === 'csv'"/>
          </div>
        </div>
      </sub-card>
    </div>

    <div class="row justify-content-end align-items-center pt-3 mb-0">
      <div class="col-auto">
        <a class="btn btn-secondary" :href="exportLink" :download="`${type}_${spec.id}.${extension}`">Export</a>
      </div>
    </div>
  </card>
</template>

<script>
    import props from "@/utils/props";

    const linkPredicates = Object.values(props.linkPredicates)
        .flatMap(linkPredicateScope => linkPredicateScope.predicates.map(pred => ({
            label: `${linkPredicateScope.prefix}:${pred}`,
            prefix: linkPredicateScope.prefix,
            uri: linkPredicateScope.uri,
            predicate: pred
        })))
        .sort((lpA, lpB) => {
            const prefixCmp = lpA.prefix.localeCompare(lpB.prefix);
            if (prefixCmp === 0)
                return lpA.predicate.localeCompare(lpB.predicate);

            return prefixCmp;
        });

    linkPredicates.push({
        label: 'Provide another link predicate',
        prefix: null,
        uri: null,
        predicate: null
    });

    export default {
        name: "Export",
        data() {
            return {
                isOpen: false,
                format: 'turtle',
                exportLinkset: true,
                exportMetadata: false,
                exportAllLinks: true,
                exportValidatedLinks: true,
                exportNotValidatedLinks: true,
                exportAcceptedLinks: true,
                exportRejectedLinks: true,
                exportUnsureLinks: true,
                reification: 'none',
                linkPredicatesList: linkPredicates,
                selectedLinkPredicate: linkPredicates[0],
                prefix: linkPredicates[0].prefix,
                uri: linkPredicates[0].uri,
                predicate: linkPredicates[0].predicate,
                creator: null,
                publisher: null,
            }
        },
        props: {
            type: String,
            spec: Object,
        },
        computed: {
            isLensSpec() {
                return this.type === 'lens';
            },

            extension() {
                switch (this.format) {
                    case 'csv':
                        return 'csv';
                    case 'trig':
                        return 'trig';
                    case 'turtle':
                    default:
                        return 'ttl';
                }
            },

            exportLink() {
                if (this.format === 'csv')
                    return this.getExportCsvLink();

                return this.getRdfExportLink();
            },
        },
        methods: {
            onToggle(isOpen) {
                this.isOpen = isOpen;
                isOpen ? this.$emit('show') : this.$emit('hide');
            },

            updateState(type) {
                switch (type) {
                    case 'export_linkset':
                        if (!this.exportLinkset)
                            this.reification = 'none'
                        if (!this.exportLinkset && !this.exportMetadata)
                            this.exportMetadata = true;
                        break;
                    case 'export_metadata':
                        if (!this.exportLinkset && !this.exportMetadata)
                            this.exportLinkset = true;
                        break;
                    case 'export_all_links':
                        this.exportValidatedLinks = this.exportAllLinks;
                        this.exportNotValidatedLinks = this.exportAllLinks;
                        this.exportAcceptedLinks = this.exportAllLinks;
                        this.exportRejectedLinks = this.exportAllLinks;
                        this.exportUnsureLinks = this.exportAllLinks;
                        if (!this.exportAllLinks)
                            this.exportAcceptedLinks = true;
                        break;
                    case 'export_validated_links':
                        this.exportAcceptedLinks = this.exportValidatedLinks;
                        this.exportRejectedLinks = this.exportValidatedLinks;
                        this.exportUnsureLinks = this.exportValidatedLinks;
                        this.exportAllLinks = this.exportValidatedLinks && this.exportNotValidatedLinks;
                        if (!this.exportAllLinks)
                            this.exportNotValidatedLinks = true;
                        break;
                    case 'export_not_validated_links':
                        this.exportAllLinks = this.exportValidatedLinks && this.exportNotValidatedLinks;
                        if (!this.exportAllLinks)
                            this.exportValidatedLinks = true;
                        break;
                    case 'export_accepted_links':
                    case 'export_rejected_links':
                    case 'export_unsure_links':
                        this.exportValidatedLinks = this.exportAcceptedLinks
                            && this.exportRejectedLinks && this.exportUnsureLinks;
                        if (!this.exportAllLinks)
                            this.exportNotValidatedLinks = true;
                        break;
                    case 'export_csv':
                        this.exportMetadata = false;
                        this.exportLinkset = true;
                        this.reification = 'none';
                        break;
                }
            },

            selectLinkPredicate(linkPredicate) {
                this.selectedLinkPredicate = linkPredicate;
                this.prefix = linkPredicate.prefix;
                this.uri = linkPredicate.uri;
                this.predicate = linkPredicate.predicate;
            },

            getExportCsvLink() {
                const params = [];

                if (this.exportAcceptedLinks) params.push('valid=accepted');
                if (this.exportRejectedLinks) params.push('valid=rejected');
                if (this.exportNotValidatedLinks) params.push('valid=not_validated');
                if (this.exportAcceptedLinks && this.exportRejectedLinks) params.push('valid=mixed');

                return this.$root.getExportCsvLink(this.type, this.spec.id, params);
            },

            getRdfExportLink() {
                const params = [];

                params.push(`export_metadata=${this.exportMetadata}`);
                params.push(`export_linkset=${this.exportLinkset}`);

                if (this.exportAcceptedLinks) params.push('valid=accepted');
                if (this.exportRejectedLinks) params.push('valid=rejected');
                if (this.exportUnsureLinks) params.push('valid=not_sure');
                if (this.exportNotValidatedLinks) params.push('valid=not_validated');
                if (this.exportAcceptedLinks && this.exportRejectedLinks) params.push('valid=mixed');

                params.push(`reification=${this.reification}`);
                params.push(`use_graphs=${this.format === 'trig'}`);

                params.push(`link_pred_namespace=${encodeURIComponent(this.uri)}`);
                params.push(`link_pred_shortname=${encodeURIComponent(this.prefix + ':' + this.predicate)}`);

                if (this.creator) params.push(`creator=${encodeURIComponent(this.creator)}`);
                if (this.publisher) params.push(`publisher=${encodeURIComponent(this.publisher)}`);

                return this.$root.getExportRdfLink(this.type, this.spec.id, params);
            }
        },
    };
</script>
